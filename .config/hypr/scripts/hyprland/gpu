#!/usr/bin/bash

HYPR_ENV_FILE="$XDG_CONFIG_HOME/hypr/settings/gpu.conf"
# NVIDIA environment variables
NVIDIA_VARS=(
    "__GL_GSYNC_ALLOWED,1"
    "GBM_BACKEND,nvidia-drm"
    "NVD_BACKEND,direct"
    "ELECTRON_OZONE_PLATFORM_HINT,auto"
    "MOZ_DISABLE_RDD_SANDBOX,1"
    "WLR_DRM_NO_ATOMIC,0"
)

# Check for NVIDIA GPU
if lspci | grep -iq "nvidia"; then
    # Clean existing NVIDIA settings
    for var in "${NVIDIA_VARS[@]}"; do
        var_name="${var%,*}"
        sed -i "/^env = ${var_name}/d" "$HYPR_ENV_FILE" 2>/dev/null
    done

    # Append new NVIDIA settings
    {
        echo -e "\n# NVIDIA-specific environment variables"
        for var in "${NVIDIA_VARS[@]}"; do
            echo "env = ${var}"
        done
    } >> "$HYPR_ENV_FILE"
    
    notify-send "NVIDIA Config Applied" "Hyprland environment variables configured for NVIDIA" -i nvidia
else
    # Remove NVIDIA settings if no GPU found
    for var in "${NVIDIA_VARS[@]}"; do
        var_name="${var%,*}"
        sed -i "/^env = ${var_name}/d" "$HYPR_ENV_FILE" 2>/dev/null
    done
    
    notify-send "NVIDIA Settings Removed" "Cleaned NVIDIA-specific variables" -i dialog-warning
fi

# Clean up empty lines and ensure trailing newline
sed -i '/^$/d' "$HYPR_ENV_FILE"
echo "" >> "$HYPR_ENV_FILE"
